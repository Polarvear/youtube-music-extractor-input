<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>YouTube Audio Extractor — Client‑Side (No URL download)</title>
  <meta name="description" content="Extract audio (MP3 or M4A) from your own video files entirely in your browser. U.S. audience. No server, no database." />
  <style>
    /* 🇰🇷 기본 스타일: 가볍고 심플한 카드 UI */
    :root { --fg:#111; --sub:#666; --bg:#f6f7f9; --card:#fff; --border:#e5e7eb; --accent:#000; }
    * { box-sizing: border-box; }
    html, body { margin:0; padding:0; background:var(--bg); color:var(--fg); font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .wrap { max-width: 860px; margin: 40px auto; padding: 0 16px; }
    h1 { font-size: 28px; margin: 0 0 6px; }
    p.lead { margin:0; color:var(--sub); font-size:14px; }
    .card { background:var(--card); border:1px solid var(--border); border-radius: 16px; padding: 20px; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .grid { display:grid; gap:16px; }

    /* 🇰🇷 업로드 존 */
    .drop { border:2px dashed var(--border); border-radius: 16px; padding: 36px; background:#fafafa; text-align:center; cursor:pointer; transition: .15s ease; }
    .drop:hover { background:#f2f2f2; }
    .muted { color:var(--sub); font-size: 14px; }
    .chosen { font-size: 13px; margin-top: 10px; color:#333; }

    /* 🇰🇷 버튼 */
    .row { display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    .btn { background:var(--accent); color:#fff; border:none; border-radius:12px; padding:10px 14px; font-weight:600; cursor:pointer; box-shadow:0 1px 2px rgba(0,0,0,.08); }
    .btn[disabled] { background:#9aa0a6; cursor:not-allowed; }

    /* 🇰🇷 프로그레스바 */
    .bar { height: 8px; background:#ececec; border-radius: 999px; overflow:hidden; width:100%; }
    .bar > i { display:block; height:100%; width:0%; background:var(--accent); transition: width .2s ease; }

    /* 🇰🇷 다운로드/오디오 */
    .download { display:inline-block; margin-top:10px; }
    .hint { font-size: 12px; color: var(--sub); }

    footer { text-align:center; color:var(--sub); font-size:12px; margin-top: 26px; }
    a { color: inherit; }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="grid">
      <h1>YouTube Audio Extractor (Client‑Side)</h1>
      <p class="lead">For your own videos or licensed content only. This tool does <strong>not</strong> download from YouTube URLs and runs entirely in your browser.</p>
    </header>

    <main class="grid" style="margin-top:16px;">
      <!-- 🇰🇷 업로드 섹션: 파일 드롭/선택만 허용 (URL 다운로드 X, 약관 준수) -->
      <section class="card grid">
        <h2 style="margin:0 0 6px;font-size:18px;">1) Add your video file</h2>
        <p class="muted">Drag & drop a video (mp4, webm, mkv, mov, m4v, avi) or click to browse.</p>

        <div id="drop" class="drop">
          <div>Drop video here or <u>click</u> to choose</div>
          <div id="chosen" class="chosen" hidden></div>
        </div>
        <input id="file" type="file" accept="video/*" hidden />

        <label class="row" style="font-size:14px; align-items:flex-start;">
          <input id="rights" type="checkbox" style="margin-top:4px;" />
          <span>I confirm I own the rights to this video or have a license that permits extracting audio. <!-- 🇰🇷 권리 보유 확인 체크박스 --></span>
        </label>
      </section>

      <!-- 🇰🇷 변환 섹션: MP3 우선, 실패 시 M4A로 폴백 -->
      <section class="card grid">
        <h2 style="margin:0 0 6px;font-size:18px;">2) Convert</h2>
        <p class="muted">Output: MP3 (fallback to M4A if needed)</p>

        <div class="row">
          <button id="go" class="btn" disabled>Load & extract</button>
          <div id="msg" class="muted">Waiting for a file…</div>
        </div>

        <div class="bar" aria-hidden="true"><i id="prog"></i></div>

        <div id="result" style="display:none;">
          <a id="dl" class="btn download" download>Download</a>
          <div style="margin-top:10px;">
            <audio id="audio" controls style="width:100%;"></audio>
          </div>
          <div class="hint" id="hint"></div>
        </div>
      </section>

      <!-- 🇰🇷 합법적 파일 획득 안내 -->
      <section class="card grid">
        <h2 style="margin:0 0 6px;font-size:18px;">How to get your YouTube video file</h2>
        <ol style="margin:6px 0 0 20px;">
          <li>Download from <strong>YouTube Studio</strong> (your uploads → menu → <em>Download</em>).</li>
          <li>Or export via <strong>Google Takeout</strong>.</li>
          <li>Then drop the file here to extract the audio.</li>
        </ol>
        <p class="hint" style="margin-top:8px;">Respect creators and the law. Do not use this tool for content you do not have rights to.</p>
      </section>
    </main>

    <footer>Built with FFmpeg.wasm. 100% in‑browser — no server, no database. <!-- 🇰🇷 모든 처리는 브라우저 내에서 수행 --></footer>
  </div>

  <!-- 🇰🇷 FFmpeg.wasm: 최신 v0.12+ ESM 사용 (FFmpeg 클래스 & @ffmpeg/util) -->
  <script type="module">
    // 🇰🇷 ESM 모듈을 직접 CDN에서 가져옵니다. v0.12+부터는 createFFmpeg 대신 FFmpeg 클래스를 사용합니다.
    import { FFmpeg } from 'https://unpkg.com/@ffmpeg/ffmpeg@0.12.15/dist/esm/ffmpeg.js';
    import { fetchFile, toBlobURL } from 'https://unpkg.com/@ffmpeg/util@0.12.2/dist/esm/index.js';

    // 🇰🇷 전역 상태
    const $ = (sel) => document.querySelector(sel);
    const drop = $('#drop');
    const fileInput = $('#file');
    const chosen = $('#chosen');
    const rights = $('#rights');
    const go = $('#go');
    const msg = $('#msg');
    const prog = $('#prog');
    const result = $('#result');
    const dl = $('#dl');
    const audio = $('#audio');
    const hint = $('#hint');

    let file = null;          // 사용자가 선택한 파일
    let urlObject = null;     // Blob URL (이전 결과 정리용)

    // 🇰🇷 드래그&드롭 + 클릭 선택 처리
    drop.addEventListener('click', () => fileInput.click());
    drop.addEventListener('dragover', (e) => { e.preventDefault(); drop.style.background = '#f2f2f2'; });
    drop.addEventListener('dragleave', () => drop.style.background = '#fafafa');
    drop.addEventListener('drop', (e) => {
      e.preventDefault(); drop.style.background = '#fafafa';
      const f = e.dataTransfer.files?.[0];
      setFile(f);
    });
    fileInput.addEventListener('change', () => setFile(fileInput.files?.[0]));

    function setFile(f) {
      if (!f) { file = null; chosen.hidden = true; syncUI(); return; }
      const ok = /\.(mp4|webm|mkv|mov|m4v|avi)$/i.test(f.name);
      if (!ok) { msg.textContent = 'Please choose a video file (mp4, webm, mkv, mov, m4v, avi).'; return; }
      file = f;
      chosen.hidden = false;
      chosen.textContent = `Selected: ${f.name} (${Math.round(f.size/1024/1024)} MB)`;
      result.style.display = 'none';
      if (urlObject) { URL.revokeObjectURL(urlObject); urlObject = null; }
      msg.textContent = 'Ready to extract.';
      syncUI();
    }

    function syncUI() {
      go.disabled = !file || !rights.checked;
      go.textContent = 'Load & extract';
    }

    rights.addEventListener('change', syncUI);

    // 🇰🇷 FFmpeg v0.12+: FFmpeg 클래스 사용
    const ffmpeg = new FFmpeg();
    ffmpeg.on('progress', ({ progress }) => {
      const pct = Math.min(100, Math.round((progress || 0) * 100));
      prog.style.width = pct + '%';
    });
    ffmpeg.on('log', ({ message }) => { console.log(message); });

    // 🇰🇷 코어 로드 (지연 로딩). CORS 회피를 위해 toBlobURL 사용 & UMD 코어 참조
    async function ensureLoaded() {
      if (ffmpeg.loaded) return;
      msg.textContent = 'Loading converter…';
      const baseURL = 'https://unpkg.com/@ffmpeg/core@0.12.15/dist/umd';
      await ffmpeg.load({
        coreURL: await toBlobURL(`${baseURL}/ffmpeg-core.js`, 'text/javascript'),
        wasmURL: await toBlobURL(`${baseURL}/ffmpeg-core.wasm`, 'application/wasm'),
      });
    }

    // 🇰🇷 변환 실행: MP3 → 실패 시 M4A
    go.addEventListener('click', async () => {
      if (!file) { msg.textContent = 'Select a video file first.'; return; }
      if (!rights.checked) { msg.textContent = 'Please confirm you have the rights or permission.'; return; }

      try {
        go.disabled = true;
        prog.style.width = '0%';

        await ensureLoaded();
        msg.textContent = 'Converting to MP3…';

        const inputName = 'input' + (file.name.match(/\.[^.]+$/)?.[0] ?? '.mp4');
        await ffmpeg.writeFile(inputName, await fetchFile(file));

        const base = file.name.replace(/\.[^.]+$/, '');
        const mp3Out = `${base}.mp3`;
        const m4aOut = `${base}.m4a`;

        let outFile = mp3Out;
        try {
          await ffmpeg.exec(['-i', inputName, '-vn', '-acodec', 'libmp3lame', '-q:a', '2', mp3Out]);
        } catch (e) {
          msg.textContent = 'MP3 failed on this build. Trying M4A (AAC)…';
          outFile = m4aOut;
          await ffmpeg.exec(['-i', inputName, '-vn', '-c:a', 'aac', '-b:a', '192k', m4aOut]);
        }

        const data = await ffmpeg.readFile(outFile);
        const mime = outFile.endsWith('.mp3') ? 'audio/mpeg' : 'audio/mp4';
        if (urlObject) URL.revokeObjectURL(urlObject);
        urlObject = URL.createObjectURL(new Blob([data.buffer], { type: mime }));

        dl.href = urlObject;
        dl.download = outFile;
        dl.textContent = `Download ${outFile}`;
        audio.src = urlObject;
        result.style.display = 'block';
        msg.textContent = 'Done.';
        hint.textContent = 'If playback fails, download the file and open it in your preferred player.';

        // 🇰🇷 가상 FS 정리
        try { await ffmpeg.deleteFile(inputName); } catch {}
        try { await ffmpeg.deleteFile(mp3Out); } catch {}
        try { await ffmpeg.deleteFile(m4aOut); } catch {}
      } catch (err) {
        console.error(err);
        msg.textContent = 'Conversion failed. See console for details.';
      } finally {
        go.disabled = !file || !rights.checked;
        go.textContent = 'Extract again';
        prog.style.width = '100%';
      }
    });
  </script>
</body>
</html>
